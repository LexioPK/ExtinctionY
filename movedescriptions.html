<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Move — Details</title>

<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">

<!-- shared header -->
<link rel="stylesheet" href="header.css">
<script src="header.js" defer></script>

<style>
  :root {
    --learn-width: 420px; /* canonical width used for "level" column when single, and column width when equal */
  }

  body {
    font-family: "Lexend", sans-serif;
    background: #f0f0f0;
    margin: 0;
    padding: 20px;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .move-card {
    background: white;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    margin-bottom: 18px;
  }

  .move-head {
    display: flex;
    align-items: center;
    gap: 18px;
  }

  .move-name {
    font-size: 1.6rem;
    font-weight: 700;
  }

  .type-badge {
    display:inline-block;
    padding:6px 10px;
    border-radius:12px;
    color: #fff;
    font-weight:700;
    margin-right:6px;
    font-size:0.95rem;
  }

  .move-stats {
    display:flex;
    gap:14px;
    margin-top:12px;
    align-items:center;
    flex-wrap:wrap;
  }

  .stat-pill {
    background:#fafafa;
    border:1px solid #e6e6e6;
    padding:8px 12px;
    border-radius:10px;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }

  .category-icon {
    width:22px;
    height:22px;
    display:inline-block;
    vertical-align:middle;
  }

  .description {
    margin-top:14px;
    line-height:1.45;
    color:#222;
  }

  .top-controls {
    margin-left:auto;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  button.nav-btn-move {
    background:#4285F4;
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
  button.nav-btn-move:disabled {
    background:#9bb8f2;
    cursor:default;
  }

  h2.section-title {
    margin: 0 0 10px 0;
    font-size:1.1rem;
    font-weight:700;
  }

  /* Two-column learner layout */
  .learn-columns {
    display:flex;
    gap:20px;
    align-items:flex-start; /* align both columns at same Y */
    margin-top:12px;
    flex-wrap:wrap;
  }

  .learn-columns.single {
    justify-content:center; /* center the single column */
  }

  .learn-col {
    flex: 1 1 0;
    min-width:300px;
  }

  /* when both present and we want equal columns, apply .equal */
  .learn-columns.equal .learn-col {
    flex: 0 0 var(--learn-width);
    max-width: var(--learn-width);
  }

  /* when only level is present, keep it at canonical width and centered via .single */
  .learn-columns.single .learn-col.learn-level {
    flex: 0 0 var(--learn-width);
    max-width: var(--learn-width);
    margin: 0 auto;
  }

  .learn-list {
    display:flex;
    flex-direction:column;
    gap:0; /* we'll use subtle borders to separate items */
    width:100%;
  }

  .learn-item {
    background: white;
    border-radius: 6px;
    padding:8px 10px;
    display:flex;
    align-items:center;
    gap:12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.02);
    border-bottom: 1px solid #eee; /* subtle line between items */
  }

  .learn-item:last-child {
    border-bottom: none;
  }

  .learn-item a.poke-link {
    display:flex;
    align-items:center;
    gap:10px;
    text-decoration:none;
    color:inherit;
  }

  .learn-item img {
    width:48px; /* slightly smaller so it sits closer */
    height:48px;
    image-rendering:pixelated;
    display:block;
    border-radius:6px;
    flex-shrink:0;
  }

  .learn-item .meta {
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:nowrap;
    min-width: 0;
  }

  .learn-item .meta .poke-link-name {
    font-weight:700;
    color:#111;
    text-decoration:none;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:180px; /* keep name compact near level */
    display:inline-block;
    vertical-align:middle;
  }

  .learn-item .learn-type {
    margin-left:auto;
    font-weight:700;
    color:#555;
    font-size:0.95rem;
    padding:6px 8px;
    background:#f7f7f7;
    border-radius:8px;
    border:1px solid #eee;
    min-width:64px;
    text-align:center;
  }

  /* type colors (subset - matches other pages) */
  .type-normal  { background:#A8A77A; }
  .type-fire    { background:#EE8130; }
  .type-water   { background:#6390F0; }
  .type-electric{ background:#F7D02C; color:#222; }
  .type-grass   { background:#7AC74C; }
  .type-ice     { background:#96D9D6; color:#222; }
  .type-fighting{ background:#C22E28; }
  .type-poison  { background:#A33EA1; }
  .type-ground  { background:#E2BF65; color:#222; }
  .type-flying  { background:#A98FF3; }
  .type-psychic { background:#F95587; }
  .type-bug     { background:#A6B91A; }
  .type-rock    { background:#B6A136; color:#222; }
  .type-ghost   { background:#735797; }
  .type-dragon  { background:#6F35FC; }
  .type-dark    { background:#705746; }
  .type-steel   { background:#B7B7CE; color:#222; }
  .type-fairy   { background:#D685AD; color:#222; }

  /* small helpers */
  .muted { color:#666; font-weight:600; }
  .center { text-align:center; }

  @media (max-width:900px) {
    .learn-columns { flex-direction:column; }
    .learn-item .meta .poke-link-name { max-width:140px; }
    .learn-columns.equal .learn-col, .learn-columns.single .learn-col.learn-level { max-width:100%; flex:1 1 auto; margin:0; }
  }

  @media (max-width:720px) {
    .move-head { flex-direction:column; align-items:flex-start; gap:10px; }
    .move-stats { width:100%; }
    .learn-item { padding:10px; }
    .top-controls { width:100%; justify-content:flex-start; margin-top:8px; }
  }
</style>
</head>
<body>
  <div class="container">
    <div id="moveCard" class="move-card">
      Loading move…
    </div>

    <div class="learn-columns" id="learnColumns">
      <div id="learnersLevel" class="move-card learn-col learn-level" style="display:none;">
        <h2 class="section-title">Learned by Level-Up</h2>
        <div id="levelList" class="learn-list"></div>
      </div>

      <div id="learnersTM" class="move-card learn-col learn-tm" style="display:none;">
        <h2 class="section-title">Learned by TM / Tutor / Egg</h2>
        <div id="tmList" class="learn-list"></div>
      </div>
    </div>
  </div>

<script>
  // get move name from ?name=...
  const moveName = decodeURIComponent(new URL(window.location.href).searchParams.get("name") || "").trim();
  const moveCard = document.getElementById("moveCard");
  const levelList = document.getElementById("levelList");
  const tmList = document.getElementById("tmList");
  const learnersLevelSection = document.getElementById("learnersLevel");
  const learnersTMSection = document.getElementById("learnersTM");
  const learnColumns = document.getElementById("learnColumns");

  // Multi-folder sprite support (same approach as pokemon.html)
  const spriteFolders = ["pokemon_sprites", "pokemon_sprties2"];
  function getPokemonImage(name) {
    const spriteName = name.toLowerCase().replace(/\s+/g, '-');
    return new Promise(resolve => {
      let i = 0;
      function tryOne() {
        if (i >= spriteFolders.length) {
          resolve('pokemon_sprites_unknown/unknown.png');
          return;
        }
        const url = `${spriteFolders[i]}/${spriteName}.png`;
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => { i++; tryOne(); };
        img.src = url;
      }
      tryOne();
    });
  }

  // We'll need the sorted list of moves to compute "next" and "prev"
  let sortedMoveNames = [];

  // Helper: category -> icon path
  const categoryIcons = {
    Physical: 'image/physical.png',
    Special:  'image/special.png',
    Status:   'image/status.png'
  };

  // load all required data
  Promise.all([
    fetch('data/moves.json').then(r => r.json()),
    fetch('data/pokedex.json').then(r => r.json()),
    fetch('data/movesets.json').then(r => r.json())
  ]).then(async ([movesData, pokedexData, movesetsData]) => {
    // Prepare sorted move name list (preserve canonical keys order)
    sortedMoveNames = Object.keys(movesData).sort((a,b) => a.localeCompare(b));

    if (!moveName) {
      moveCard.innerHTML = '<div class="muted">No move specified.</div>';
      return;
    }

    // try direct lookup then case-insensitive fallback
    const canonicalKey = Object.keys(movesData).find(k => k.toLowerCase() === moveName.toLowerCase()) || moveName;
    const mv = movesData[canonicalKey];

    if (!mv) {
      moveCard.innerHTML = `<div class="muted">Move "${escapeHtml(moveName)}" not found in data/moves.json.</div>`;
      return;
    }

    // Build next-move and prev-move buttons
    const currentIndex = sortedMoveNames.findIndex(n => n.toLowerCase() === canonicalKey.toLowerCase());
    const nextIndex = (currentIndex >= 0) ? (currentIndex + 1) % sortedMoveNames.length : -1;
    const prevIndex = (currentIndex >= 0) ? (currentIndex - 1 + sortedMoveNames.length) % sortedMoveNames.length : -1;
    const nextMoveName = (nextIndex >= 0) ? sortedMoveNames[nextIndex] : null;
    const prevMoveName = (prevIndex >= 0) ? sortedMoveNames[prevIndex] : null;

    // Render top section: name, type badge, category (icon), power, acc, PP, description
    const typeHtml = mv.Type ? `<span class="type-badge type-${mv.Type.toLowerCase()}">${mv.Type}</span>` : '';
    const categoryLabel = mv.Category || '';
    const power = mv.Power ?? '—';
    const acc = (mv.Acc === undefined || mv.Acc === null) ? '—' : `${mv.Acc}%`;
    const pp = mv.PP ?? '—';
    const desc = mv.Description || 'No description available.';

    // Determine category icon (fallback to text if missing)
    const catIcon = categoryIcons[categoryLabel] || '';
    const catHtml = catIcon ? `<img src="${catIcon}" class="category-icon" alt="${escapeHtml(categoryLabel)}">` : escapeHtml(categoryLabel);

    // Create top-controls including Prev & Next buttons
    const prevButtonHtml = prevMoveName
      ? `<button id="prevMoveBtn" class="nav-btn-move">Prev: ${escapeHtml(prevMoveName)}</button>`
      : `<button id="prevMoveBtn" class="nav-btn-move" disabled>Prev</button>`;

    const nextButtonHtml = nextMoveName
      ? `<button id="nextMoveBtn" class="nav-btn-move">Next: ${escapeHtml(nextMoveName)}</button>`
      : `<button id="nextMoveBtn" class="nav-btn-move" disabled>Next</button>`;

    moveCard.innerHTML = `
      <div class="move-head">
        <div>
          <div class="move-name">${escapeHtml(canonicalKey)}</div>
          <div style="margin-top:6px">${typeHtml}</div>
        </div>

        <div class="top-controls">
          ${prevButtonHtml}
          ${nextButtonHtml}
        </div>
      </div>

      <div class="move-stats">
        <div class="stat-pill"><span class="muted">Category</span> ${catHtml}</div>
        <div class="stat-pill"><span class="muted">Power</span> ${escapeHtml(String(power))}</div>
        <div class="stat-pill"><span class="muted">Accuracy</span> ${escapeHtml(String(acc))}</div>
        <div class="stat-pill"><span class="muted">PP</span> ${escapeHtml(String(pp))}</div>
      </div>

      <div class="description">${escapeHtml(desc)}</div>
    `;

    // wire prev/next buttons
    const nextBtn = document.getElementById('nextMoveBtn');
    if (nextBtn && nextMoveName) {
      nextBtn.addEventListener('click', () => {
        location.href = `movedescriptions.html?name=${encodeURIComponent(nextMoveName)}`;
      });
    }
    const prevBtn = document.getElementById('prevMoveBtn');
    if (prevBtn && prevMoveName) {
      prevBtn.addEventListener('click', () => {
        location.href = `movedescriptions.html?name=${encodeURIComponent(prevMoveName)}`;
      });
    }

    // Clear previous lists (important if the page is navigated to via JS)
    levelList.innerHTML = '';
    tmList.innerHTML = '';

    // Find learners by level-up: iterate movesetsData (movesetsData[pokemon] => array of {Level, Move})
    const levelLearners = [];
    for (const [pokeName, movelist] of Object.entries(movesetsData || {})) {
      if (!Array.isArray(movelist)) continue;
      for (const entry of movelist) {
        if (!entry || !entry.Move) continue;
        if (entry.Move === canonicalKey || entry.Move.toLowerCase() === canonicalKey.toLowerCase()) {
          const lvl = (entry.Level === undefined || entry.Level === null) ? null : entry.Level;
          levelLearners.push({ pokeName, level: lvl });
        }
      }
    }

    // Find learners by TM/HM/Tutor/Egg via pokedexData (mon.TMs array used by pokemon.html)
    const tmLearners = [];
    for (const [pokeName, mon] of Object.entries(pokedexData || {})) {
      if (!mon) continue;
      const tms = mon.TMs || [];
      if (Array.isArray(tms)) {
        for (const tm of tms) {
          if (!tm || !tm.Move) continue;
          if (tm.Move === canonicalKey || tm.Move.toLowerCase() === canonicalKey.toLowerCase()) {
            const label = tm.Label || 'TM';
            tmLearners.push({ pokeName, label });
          }
        }
      }
      if (Array.isArray(mon.EggMoves)) {
        if (mon.EggMoves.includes(canonicalKey) || mon.EggMoves.map(m=>m.toLowerCase()).includes(canonicalKey.toLowerCase())) {
          tmLearners.push({ pokeName, label: 'Egg' });
        }
      }
    }

    // Sort level learners by level (nulls after)
    levelLearners.sort((a,b) => {
      const la = a.level === null ? 9999 : Number(a.level);
      const lb = b.level === null ? 9999 : Number(b.level);
      if (la === lb) return a.pokeName.localeCompare(b.pokeName);
      return la - lb;
    });

    // Sort tm learners alphabetically
    tmLearners.sort((a,b) => a.pokeName.localeCompare(b.pokeName));

    // Show/hide sections and apply layout classes
    const hasLevel = levelLearners.length > 0;
    const hasTM = tmLearners.length > 0;

    learnersLevelSection.style.display = hasLevel ? 'block' : 'none';
    learnersTMSection.style.display = hasTM ? 'block' : 'none';

    // set classes:
    // - if both present -> .equal so both columns use canonical width and are equal
    // - if only level present -> .single so level column uses canonical width and is centered
    // - otherwise remove modifiers
    learnColumns.classList.remove('equal','single');
    if (hasLevel && hasTM) {
      learnColumns.classList.add('equal');
    } else if (hasLevel && !hasTM) {
      learnColumns.classList.add('single');
    }

    // Render level learners (compact layout). Make image+name clickable to pokemon page.
    if (hasLevel) {
      for (const ln of levelLearners) {
        const name = ln.pokeName;
        const lvl = ln.level;
        const entry = document.createElement('div');
        entry.className = 'learn-item';

        // image url
        const imgUrl = await getPokemonImage(name);

        // Anchor wraps image and name so the pokemon is clickable
        const pokeHref = `pokemon.html?name=${encodeURIComponent(name)}`;

        entry.innerHTML = `
          <a class="poke-link" href="${pokeHref}" title="${escapeHtml(name)}">
            <img src="${imgUrl}" alt="${escapeHtml(name)}">
            <div class="meta">
              <div class="poke-link-name">${escapeHtml(name)}</div>
            </div>
          </a>
          <div class="learn-type">${lvl ? 'Lv ' + escapeHtml(String(lvl)) : 'Lv'}</div>
        `;
        levelList.appendChild(entry);
      }
    }

    // Render TM learners. Also make clickable.
    if (hasTM) {
      for (const tn of tmLearners) {
        const name = tn.pokeName;
        const label = tn.label || 'TM';
        const entry = document.createElement('div');
        entry.className = 'learn-item';

        const imgUrl = await getPokemonImage(name);
        const pokeHref = `pokemon.html?name=${encodeURIComponent(name)}`;

        entry.innerHTML = `
          <a class="poke-link" href="${pokeHref}" title="${escapeHtml(name)}">
            <img src="${imgUrl}" alt="${escapeHtml(name)}">
            <div class="meta">
              <div class="poke-link-name">${escapeHtml(name)}</div>
            </div>
          </a>
          <div class="learn-type">${escapeHtml(String(label))}</div>
        `;
        tmList.appendChild(entry);
      }
    }

    // If neither, show a helpful message
    if (!hasLevel && !hasTM) {
      const note = document.createElement('div');
      note.className = 'muted';
      note.style.padding = '8px 6px';
      note.textContent = 'No Pokémon found that learn this move (according to data/movesets.json and data/pokedex.json).';
      moveCard.appendChild(note);
    }

  }).catch(err => {
    console.error(err);
    moveCard.innerHTML = `<div class="muted">Error loading move data: ${escapeHtml(String(err))}</div>`;
  });

  // small helper for safety
  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, c => {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];
    });
  }
</script>
</body>
</html>
